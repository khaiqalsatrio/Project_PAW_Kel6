<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Booking Customer</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
        background-color: whitesmoke;
      }
      .ticket {
        background-color: white;
        border-radius: 25px;
        padding: 20px;
        margin-bottom: 20px; /* Jarak antar tiket */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        position: relative;
      }
      .ticket-header {
        background-color: rgb(73, 194, 208);
        color: white;
        padding: 10px;
        border-radius: 10px 10px 0 0;
        text-align: center;
        font-weight: bold;
      }
      .ticket-body {
        padding: 15px;
      }
      .ticket-body div {
        margin-bottom: 10px;
      }
      .ticket-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 10px;
        border-top: 1px solid #ddd;
      }
      footer {
        background-color: #0d6efd;
        color: white;
        text-align: center;
        padding: 5px 0;
      }
      .print-btn-container {
        text-align: center;
        margin-top: 20px;
      }

      .ticket-footer button {
      margin-left: 10px; /* Jarak kiri */
      margin-right: 10px; /* Jarak kanan */
      }

      .ticket-footer button:first-child {
        margin-left: 0; /* Tidak ada margin kiri pada tombol pertama */
      }

      .ticket-footer button:last-child {
        margin-right: 0; /* Tidak ada margin kanan pada tombol terakhir */
      }

      .container.content {
        flex-grow: 1;
        margin-top: 20px; /* Jarak antara navbar dan konten */
        margin-bottom: 20px; /* Jarak antara konten dan tiket */
      }

      h2 {
        color: rgb(73, 194, 208);
        text-align: center;
        margin-bottom: 20px;
      }

      h2::after {
        content: "";
        display: block;
        width: 100%;
        height: 3px;
        background-color: #ddd;
        margin-top: 10px;
      }

    </style>
  </head>
  <body>
    <div class="container content">
      <h2 class="text-center" style="color: rgb(73, 194, 208);">Detail Booking</h2>
      <% customer.forEach((dataCustomer) => { %>
      <div class="ticket">
        <div class="ticket-header">Booking ID: <%= dataCustomer.id %></div>
        <div class="ticket-body">
          <div><strong>Nama Lengkap:</strong> <%= dataCustomer.nama %></div>
          <div><strong>Email Pribadi:</strong> <%= dataCustomer.email %></div>
          <div><strong>No Telepon:</strong> <%= dataCustomer.phone_number %></div>
          <div><strong>Jenis Kamar:</strong> <%= dataCustomer.jenis_room %></div>
          <div><strong>Check-in:</strong> <%=(dataCustomer.check_in_date) %></div>
          <div><strong>Check-out:</strong> <%=(dataCustomer.check_out_date) %></div>
          <div><strong>Harga:</strong> <%=(dataCustomer.harga) %></div>
        </div>
        <div class="ticket-footer d-flex justify-content-center">
          <button class="btn btn-primary btn-block downloadPdfBtn" data-id="<%= dataCustomer.id %>"><i class="bi bi-file-earmark-pdf"></i> Download PDF </button>
          <button class="btn btn-sm btn-success btn-block ml-2 mr-2 editBtn" data-id="<%= dataCustomer.id %>"><i class="bi bi-pencil"></i> Edit</button>
          <button class="btn btn-sm btn-danger btn-block ml-2 mr-2 deleteBtn" data-id="<%= dataCustomer.id %>"><i class="bi bi-trash"></i> Cencel</button>
        </div>
      </div>
      <% }); %>
      <% if (customer.length === 0) { %>
      <div class="alert alert-warning text-center" role="alert">Belum ada Pemesanan.</div>
      <% } %>
    </div>    

    <!-- Notifikasi Konfirmasi Penghapusan -->
    <div id="confirmDeleteModal" class="modal fade" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmDeleteModalLabel">Konfirmasi Penghapusan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Apakah Anda yakin ingin menghapus data ini?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tidak</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Cancel Booking</button>                       
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <footer class="text-white text-center py-2 mt-5" style="background-color: rgb(35, 33, 33)">
      <p class="mb-0">&copy; 2024 Hotel Murah. All rights reserved.</p>
    </footer>
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>

    <script>
      // Function untuk format tanggal dan harga //
      $(document).ready(function () {
        // Function untuk tombol delete //
        $(document).ready(function () {
          let selectedCustomerId = null;
          // Event listener untuk tombol Delete
          $(".deleteBtn").on("click", function () {
            selectedCustomerId = $(this).data("id");
            $("#confirmDeleteModal").modal("show");
          });
          // Event listener untuk tombol Hapus di modal konfirmasi
          $("#confirmDeleteBtn").on("click", function () {
            if (selectedCustomerId) {
              $.ajax({
                url: "/dataCustomer/" + selectedCustomerId,
                type: "DELETE",
                success: function () {
                  $("#confirmDeleteModal").modal("hide");
                  location.reload();
                },
                error: function (xhr) {
                  console.error("Error deleting customer:", xhr.responseText);
                  alert("Terjadi kesalahan saat menghapus data.");
                },
              });
            }
          });
        });
      });

      let selectedCustomerId = null; // Untuk menyimpan ID customer yang akan diedit
      // Event listener untuk tombol Edit
      $(".editBtn").on("click", function () {
        selectedCustomerId = $(this).data("id"); // Ambil ID customer dari tombol
        // Ambil data dari baris tabel yang sesuai
        const row = $(this).closest("tr");
        const nama = row.find("td:nth-child(1)").text();
        const email = row.find("td:nth-child(2)").text();
        const phoneNumber = row.find("td:nth-child(3)").text();
        const jenisKamar = row.find("td:nth-child(4)").text();
        const checkIn = row.find("td:nth-child(5)").text();
        const checkOut = row.find("td:nth-child(6)").text();
        const harga = row.find("td:nth-child(7)").text();

        // Isi modal dengan data dari baris tabel
        $("#editNama").val(nama);
        $("#editEmail").val(email);
        $("#editPhoneNumber").val(phoneNumber);
        $("#editJenisKamar").val(jenisKamar);
        $("#editCheckIn").val(checkIn);
        $("#editCheckOut").val(checkOut);
        $("#editHarga").val(harga);
        // Tampilkan modal
        $("#editModal").modal("show");
      });

      // Event listener untuk tombol Simpan di modal
      $("#saveEditBtn").on("click", function () {
        const updatedData = {
          nama: $("#editNama").val(),
          email: $("#editEmail").val(),
          phone_number: $("#editPhoneNumber").val(),
          jenis_room: $("#editJenisKamar").val(),
          check_in_date: $("#editCheckIn").val(),
          check_out_date: $("#editCheckOut").val(),
          harga: $("#editHarga").val(),
        };

        // Kirim data ke server dengan AJAX
        $.ajax({
          url: "/dataCustomer/" + selectedCustomerId,
          type: "PUT",
          contentType: "application/json",
          data: JSON.stringify(updatedData),
          success: function () {
            // Tutup modal dan refresh halaman
            $("#editModal").modal("hide");
            location.reload();
          },
          error: function (xhr) {
            console.error("Error updating customer:", xhr.responseText);
            alert("Terjadi kesalahan saat menyimpan data.");
          },
        });
      });

      // Berfungsi untuk memformat harga ke dalam format Rupiah (misal Rp 1.500.000)
      function formatRupiah(number) {
        return "Rp " + number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }

      // Fungsi untuk mencetak halaman menjadi PDF
          document.addEventListener("DOMContentLoaded", function () {
          document.getElementById("printBtn").addEventListener("click", function () {
          const { jsPDF } = window.jspdf;  // Mengambil jsPDF dari library
          
          const doc = new jsPDF();
          
          // Mengambil konten dari halaman detail booking
          const content = document.querySelector('.content').innerHTML;
          
          // Menambahkan konten ke dalam PDF
          doc.html(content, {
            callback: function (doc) {
              // Menyimpan file PDF dengan nama "Booking-Details.pdf"
              doc.save('Booking-Details.pdf');
            },
            margin: [10, 10, 10, 10],  // Margin PDF (atas, kiri, bawah, kanan)
            x: 10,
            y: 10,
          });
        });
      });
          
      $(document).ready(function () {
      $(".downloadPdfBtn").on("click", function () {
        const ticketId = $(this).data("id");
        const ticketElement = $(this).closest(".ticket");
      
        if (!ticketElement.length) {
          console.error(`Elemen dengan ID ticket-${ticketId} tidak ditemukan.`);
          return;
        }
      
        // Menambahkan elemen untuk tanggal pemesanan
        const currentDate = new Date();
        const formattedDate = currentDate.toLocaleDateString('id-ID', {
          day: '2-digit',
          month: 'long',
          year: 'numeric',
        });
      
        const dateElement = $(`<div class="ticket-date">Tanggal Booking: ${formattedDate}</div>`);
        ticketElement.append(dateElement);
      
        // Sembunyikan tombol download PDF, Edit, dan Delete sementara sebelum membuat PDF
        const downloadButton = $(this); // Tombol Download PDF
        const editButton = ticketElement.find(".editBtn"); // Tombol Edit
        const deleteButton = ticketElement.find(".deleteBtn"); // Tombol Delete
      
        downloadButton.hide(); // Menyembunyikan tombol Download PDF
        editButton.hide(); // Menyembunyikan tombol Edit
        deleteButton.hide(); // Menyembunyikan tombol Delete
      
        // Menggunakan html2pdf.js untuk langsung mengonversi elemen HTML menjadi PDF
        const element = ticketElement[0];
        const opt = {
          margin: 1,
          filename: `Ticket-${ticketId}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        };
      
        // Memulai proses konversi dan download PDF
        html2pdf().from(element).set(opt).save().then(function () {
          // Setelah PDF selesai diunduh, tampilkan kembali tombol-tombol yang disembunyikan
          downloadButton.show(); // Menampilkan kembali tombol Download PDF
          editButton.show(); // Menampilkan kembali tombol Edit
          deleteButton.show(); // Menampilkan kembali tombol Delete
          // Hapus elemen tanggal setelah PDF diunduh
          dateElement.remove();
        });
      });
    });
    </script>
  </body>
</html>